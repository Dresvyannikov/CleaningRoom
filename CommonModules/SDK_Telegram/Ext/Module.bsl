#Область Методы

Функция ПолучитьСпиокСообщений() Экспорт
	
	Результат = getUpdates(Константы.update_id.Получить() + 1);
	
	Если Результат.Свойство("ok") И Результат.ok = Истина Тогда
		Если Результат.Свойство("result") Тогда
			Для каждого НовоеСообщение Из Результат.result Цикл
				Если НовоеСообщение.Свойство("message") И НовоеСообщение.message.Свойство("chat") Тогда
					chat = НовоеСообщение.message.chat;	
					id = chat.id;
					Если НовоеСообщение.message.text = "/start" Тогда
						Сообщение = "Я чат бот, приветствую вас!" + Символы.ПС +
						"У меня есть несколько функций, котрые помогут вам с заказами:"+ Символы.ПС +
						"Для создания нового заказа отправьте /NewOrder" + Символы.ПС +
						"Для получения инвормации о ваших заказах /MyOrder" + Символы.ПС;
						//"Для получения документа отправьте:" + Символы.ПС +
						//"Текстовый /txt" + Символы.ПС +
						//"PDF /pdf" + Символы.ПС +
						//"Картинка /jpg" + Символы.ПС;
						sendMessage(id, Сообщение);
					ИначеЕсли НовоеСообщение.message.text = "/NewOrder" Тогда
						Если ПроверитьСозданиеПоID(id) = Истина Тогда 
							Сообщение = "Ваш заказ уже создается, когда менеджер его примет, вам придет сообщение от бота";
							sendMessage(id, Сообщение);
							Возврат Результат;
						КонецЕсли;
						Сообщение = "Для создания нового заказа напишите необходимую информацию в таком формате, чтобы менеджер смог с вами связаться:"+Символы.ПС+
						"1. Телефон"+ Символы.ПС +
						"2. Адрес"+ Символы.ПС +
						"3. Площадь помещения (не обязательно)"+ Символы.ПС +
						"Сообщение с информацией напишите ответом на это сообщение"; 
						sendMessage(id, Сообщение); 
						ИначеЕсли НовоеСообщение.message.Свойство("reply_to_message") Тогда 
							Если СтрНачинаетсяС(НовоеСообщение.message.reply_to_message.text,"Для создания нового заказа напишите необходимую информацию в таком формате, чтобы менеджер смог с вами связаться:") Тогда 
								НомерЗаказа = СоздатьЗаказ(НовоеСообщение); 
								
								МенеджерЗап = РегистрыСведений.СтатусыСозданияЗаказов.СоздатьМенеджерЗаписи();
								МенеджерЗап.ChatId = id;
								МенеджерЗап.ЗаказСоздается = Истина;
								МенеджерЗап.Записать(); 
								
								Сообщение = "Ваш заказ №"+НомерЗаказа+" создан. Когда заказ будет принят с вами свяжется менеджер";
								sendMessage(id, Сообщение);
							КонецЕсли;	
						ИначеЕсли НовоеСообщение.message.text = "/MyOrder" Тогда
						
					//ИначеЕсли НовоеСообщение.message.text = "/txt" Тогда 	
					//	sendDocument(id,,,,,, "С:\222\test.txt");		
					//ИначеЕсли НовоеСообщение.message.text = "/pdf" Тогда 	
					//	sendDocument(id,,,,,, "С:\222\tel_doc.pdf");		
					//ИначеЕсли НовоеСообщение.message.text = "/jpg" Тогда 	
					//	sendDocument(id,,,,,, "/Volumes/PROJECTS/222/233.png");		
					//Иначе	
					//	sendMessage(id, "Я получил ваше сообщение.");
					КонецЕсли;
					Константы.update_id.Установить(НовоеСообщение.update_id);
				КонецЕсли; 
			КонецЦикла; 	
		КонецЕсли; 
	КонецЕсли; 
	              
	Возврат Результат;
КонецФункции
 
#КонецОбласти 

Функция ПроверитьСозданиеПоID(ID)                                                     
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СтатусыСозданияЗаказов.ЗаказСоздается КАК ЗаказСоздается
		|ИЗ
		|	РегистрСведений.СтатусыСозданияЗаказов КАК СтатусыСозданияЗаказов
		|ГДЕ
		|	СтатусыСозданияЗаказов.ChatId = &ChatId";
	
	Запрос.УстановитьПараметр("ChatId", Строка(ID));
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Если  ВыборкаДетальныеЗаписи.Следующий() Тогда 
		Возврат ВыборкаДетальныеЗаписи.ЗаказСоздается;	
	КонецЕсли;
КонецФункции 

Функция СоздатьЗаказ(НовоеСообщение)  
	ТекстСообщения = НовоеСообщение.message.text;
	
	НовыйЗаказ = Документы.Заказы.СоздатьДокумент();
	НовыйЗаказ.ЧатИД = НовоеСообщение.message.chat.id;
	НовыйЗаказ.ТелефонЗаказчика = Сред(ТекстСообщения,СтрНайти(НовоеСообщение.message.text,"1. ")+3,СтрДлина(ТекстСообщения) - СтрНайти(ТекстСообщения,"2. ")-5);
	НовыйЗаказ.Адрес = Сред(ТекстСообщения,СтрНайти(НовоеСообщение.message.text,"2. ")+3,СтрДлина(ТекстСообщения) - СтрНайти(ТекстСообщения,"3. ")-5);
	НовыйЗаказ.СтатусЗаказа = Перечисления.СтатусЗаказа.Создан;
	НовыйЗаказ.Дата = ТекущаяДата();
	НовыйЗаказ.Записать(РежимЗаписиДокумента.Проведение); 
	Возврат НовыйЗаказ.Номер;
КонецФункции

#Область TelegramAPI

// Функция - Get updates
//
// Параметры:
//  offset	 - 	 - 
//  limit	 - 	 - 
//  timeout	 - 	 - 
// 
// Возвращаемое значение:
//   - 
//
Функция getUpdates(offset = 0, limit = 0, timeout = 0) Экспорт
	
	method_param = Новый Массив;
	Если offset > 0 Тогда
		method_param.Добавить("offset=" + ФорматироватьСтроку(offset));
	КонецЕсли; 
	Если limit > 0 Тогда
		method_param.Добавить("limit=" + ФорматироватьСтроку(limit));
	КонецЕсли; 
	Если timeout > 0 Тогда
		method_param.Добавить("timeout=" + ФорматироватьСтроку(timeout));
	КонецЕсли; 
	
	Результат = ОтправитьHTTPЗапрос(ПолучитьAccessToken(), "getUpdates", method_param);
	
	Возврат ОбработатьJSON(Результат);
КонецФункции

// Функция - Send message
//
// Параметры:
//  chat_id					 - 	 - 
//  text					 - 	 - 
//  parse_mode				 - 	 - 
//  disable_web_page_preview - 	 - 
//  disable_notification	 - 	 - 
//  reply_to_message_id		 - 	 - 
//  reply_markup			 - 	 - 
// 
// Возвращаемое значение:
//   - 
//
Функция sendMessage(chat_id, text, parse_mode = Неопределено, disable_web_page_preview = Неопределено, disable_notification = Неопределено, reply_to_message_id = 0, reply_markup = Неопределено) Экспорт
	
	Если НЕ ЗначениеЗаполнено(chat_id) ИЛИ НЕ ЗначениеЗаполнено(text) Тогда
		Возврат Неопределено;
	КонецЕсли; 
	
	method_param = Новый Массив;
	method_param.Добавить("chat_id=" + ФорматироватьСтроку(chat_id));
	method_param.Добавить("text=" + text);
	Если НЕ parse_mode = Неопределено Тогда
		method_param.Добавить("parse_mode=" + parse_mode);
	КонецЕсли; 
	Если НЕ disable_web_page_preview = Неопределено Тогда
		method_param.Добавить("disable_web_page_preview=" + disable_web_page_preview);
	КонецЕсли; 
	Если НЕ disable_notification = Неопределено Тогда
		method_param.Добавить("disable_notification=" + disable_notification);
	КонецЕсли; 
	Если reply_to_message_id > 0 Тогда
		method_param.Добавить("reply_to_message_id=" + ФорматироватьСтроку(reply_to_message_id));
	КонецЕсли; 
	Если НЕ reply_markup = Неопределено Тогда
		method_param.Добавить("reply_markup=" + reply_markup);
	КонецЕсли; 
	
	Результат = ОтправитьHTTPЗапрос(ПолучитьAccessToken(), "sendMessage", method_param);
	
	Возврат ОбработатьJSON(Результат);
КонецФункции

Функция sendDocument(chat_id, document, caption = Неопределено, disable_notification = Неопределено, reply_to_message_id = 0, reply_markup = Неопределено, ИмяФайлаПолное) Экспорт
	
	Если НЕ ЗначениеЗаполнено(chat_id) Тогда
		Возврат Неопределено;
	КонецЕсли; 	
	
	method_param = Новый Массив;
	method_param.Добавить("chat_id=" + ФорматироватьСтроку(chat_id));
	
	ДлинаИмени = СтрДлина(ИмяФайлаПолное) - СтрНайти(ИмяФайлаПолное, "\", НаправлениеПоиска.СКонца);
	ИмяФайла = Прав(ИмяФайлаПолное, ДлинаИмени);
	
	Данные = Новый Соответствие;
	Данные.Вставить("Boundary", "----" + Строка(Новый УникальныйИдентификатор));
	Данные.Вставить("ИмяФайлаПолное", ИмяФайлаПолное);
	Данные.Вставить("ИмяФайла", ИмяФайла);
	Данные.Вставить("name", "document");
	
	Результат = ОтправитьHTTPЗапрос(ПолучитьAccessToken(), "sendDocument", method_param, Данные);
	
	Возврат ОбработатьJSON(Результат);
КонецФункции

Функция sendPhoto(chat_id, photo, caption = Неопределено, disable_notification = Неопределено, reply_to_message_id = 0, reply_markup = Неопределено, ИмяФайлаПолное) Экспорт
	Если НЕ ЗначениеЗаполнено(chat_id) Тогда
		Возврат Неопределено;
	КонецЕсли; 	
	
	method_param = Новый Массив;
	method_param.Добавить("chat_id=" + ФорматироватьСтроку(chat_id));
	
	ДлинаИмени = СтрДлина(ИмяФайлаПолное) - СтрНайти(ИмяФайлаПолное, "\", НаправлениеПоиска.СКонца);
	ИмяФайла = Прав(ИмяФайлаПолное, ДлинаИмени);
	
	Данные = Новый Соответствие;
	Данные.Вставить("Boundary", "----" + Строка(Новый УникальныйИдентификатор));
	Данные.Вставить("ИмяФайлаПолное", ИмяФайлаПолное);
	Данные.Вставить("ИмяФайла", ИмяФайла);
	Данные.Вставить("name", "photo");
	
	Результат = ОтправитьHTTPЗапрос(ПолучитьAccessToken(), "sendPhoto", method_param, Данные);
	
	Возврат ОбработатьJSON(Результат);
КонецФункции

#КонецОбласти 

#Область WEB

#Область Интерфейс

Функция ОтправитьHTTPЗапрос(access_token, method, method_param = Неопределено, Данные = Неопределено) Экспорт
	
	Результат = Неопределено;
	
	Попытка
		ssl = Новый ЗащищенноеСоединениеOpenSSL();
		
		Прокси = Новый ИнтернетПрокси;
		Прокси.Установить("https", Константы.Прокси.Получить(), Константы.Порт.Получить());
		
		СоединениеHTTP = Новый HTTPСоединение("api.telegram.org", 443,,,Прокси,,ssl);
		
		ПараметрыЗапроса = Новый Соответствие;
		ПараметрыЗапроса.Вставить("access_token", access_token);
		ПараметрыЗапроса.Вставить("method", method);
		ПараметрыЗапроса.Вставить("method_param", method_param);
		
		HTTPЗапрос = Новый HTTPЗапрос;
		Если Данные = Неопределено Тогда
			HTTPЗапрос.Заголовки.Вставить("Content-type", "application/json");
		Иначе
			HTTPЗапрос.Заголовки.Вставить("Content-type", "multipart/form-data; boundary=" + Данные["Boundary"]);
			
			ТекстЗапроса = СформироватьТекстЗапроса(Данные);
			HTTPЗапрос.УстановитьТелоИзСтроки(ТекстЗапроса, КодировкаТекста.ANSI, ИспользованиеByteOrderMark.НеИспользовать);
		КонецЕсли; 
		HTTPЗапрос.АдресРесурса = СформироватьМетод(ПараметрыЗапроса);
		
		Если Данные = Неопределено Тогда
			РезультатЗапроса = СоединениеHTTP.Получить(HTTPЗапрос);
		Иначе	
			РезультатЗапроса = СоединениеHTTP.ОтправитьДляОбработки(HTTPЗапрос);
		КонецЕсли; 
		
		Если РезультатЗапроса.КодСостояния = 200 Тогда
			Результат = РезультатЗапроса.ПолучитьТелоКакСтроку();
		Иначе
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = РезультатЗапроса.ПолучитьТелоКакСтроку();
			Сообщение.Сообщить(); 
		КонецЕсли; 
		
	Исключение
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = ОписаниеОшибки();
		Сообщение.Сообщить(); 
	КонецПопытки; 
	
	Возврат Результат;
КонецФункции
 
#КонецОбласти 

#Область СлужебныеПроцедурыИФункции

Функция СформироватьМетод(ПараметрыЗапроса)
	Стр = "";
	ПараметрыМетода = "";
	
	// Переделать формирование строки с методом и параметрами под конкретный API
	// данная реализация для ВКонтакте
	Если ЗначениеЗаполнено(ПараметрыЗапроса["method_param"]) Тогда
		Для каждого Строка Из ПараметрыЗапроса["method_param"] Цикл
			ПараметрыМетода = ПараметрыМетода + Строка + "&";
		КонецЦикла; 
	КонецЕсли; 
	
	Если ЗначениеЗаполнено(ПараметрыМетода) Тогда
		Стр = "bot" + ПараметрыЗапроса["access_token"] + "/" + ПараметрыЗапроса["method"] + "?";
		Стр = Стр + ПараметрыМетода;
	Иначе
		Стр = "bot" + ПараметрыЗапроса["access_token"] + "/" + ПараметрыЗапроса["method"];
	КонецЕсли; 
	
	Возврат Стр;
КонецФункции
 
Функция СформироватьJSON(СтруктураДанных, ФормироватьСПереносами = Ложь) Экспорт
	
	ЗаписьJSON = Новый ЗаписьJSON;
	Если ФормироватьСПереносами Тогда
		ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(, Символы.Таб));
	Иначе
		ЗаписьJSON.УстановитьСтроку(Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Нет, Символы.Таб));
	КонецЕсли; 
	
	НастройкиСериализацииJSON = Новый НастройкиСериализацииJSON;
	НастройкиСериализацииJSON.ВариантЗаписиДаты = ВариантЗаписиДатыJSON.ЛокальнаяДатаСоСмещением;
	НастройкиСериализацииJSON.ФорматСериализацииДаты = ФорматДатыJSON.ISO;
	
	ЗаписатьJSON(ЗаписьJSON, СтруктураДанных, НастройкиСериализацииJSON);
	
	Возврат ЗаписьJSON.Закрыть();
КонецФункции
 
Функция ОбработатьJSON(СтрокаJSON) Экспорт
	СтруктураВозврата = Новый Структура;
	
	Попытка
		Чтение = Новый ЧтениеJSON;
		Чтение.УстановитьСтроку(СтрокаJSON);
		
		СтруктураВозврата = ПрочитатьJSON(Чтение);
	Исключение
	КонецПопытки; 
	
	Возврат СтруктураВозврата;
КонецФункции
 
Функция ЗаписатьЛог(Данные) Экспорт
	Попытка
		ИмяФайлаЛога = ПолучитьПутьКФайлуЛога();
		ФайлЛога = Новый Файл(ИмяФайлаЛога);
		
		ТекстовыйДокумент = Новый ТекстовыйДокумент;
		Если НЕ ФайлЛога.Существует() Тогда
			ТекстовыйДокумент.ДобавитьСтроку(Данные);
		Иначе
			ТекстовыйДокумент.Прочитать(ИмяФайлаЛога);
			ТекстовыйДокумент.ДобавитьСтроку(Данные);
		КонецЕсли; 
		ТекстовыйДокумент.Записать(ИмяФайлаЛога);
	Исключение
	КонецПопытки; 
КонецФункции
 
Функция РазложитьСтрокуВМассивПодстрок(Знач Строка, Знач Разделитель = ",",
    Знач ПропускатьПустыеСтроки = Неопределено) Экспорт
 
    Результат = Новый Массив;
 
    // для обеспечения обратной совместимости
    Если ПропускатьПустыеСтроки = Неопределено Тогда
        ПропускатьПустыеСтроки = ?(Разделитель = " ", Истина, Ложь);
        Если ПустаяСтрока(Строка) Тогда 
            Если Разделитель = " " Тогда
                Результат.Добавить("");
            КонецЕсли;
            Возврат Результат;
        КонецЕсли;
    КонецЕсли;
    //
 
    Позиция = Найти(Строка, Разделитель);
    Пока Позиция > 0 Цикл
        Подстрока = Лев(Строка, Позиция - 1);
        Если Не ПропускатьПустыеСтроки Или Не ПустаяСтрока(Подстрока) Тогда
            Результат.Добавить(Подстрока);
        КонецЕсли;
        Строка = Сред(Строка, Позиция + СтрДлина(Разделитель));
        Позиция = Найти(Строка, Разделитель);
    КонецЦикла;
 
    Если Не ПропускатьПустыеСтроки Или Не ПустаяСтрока(Строка) Тогда
        Результат.Добавить(Строка);
    КонецЕсли;
 
    Возврат Результат;
 
КонецФункции

Функция ФорматироватьСтроку(ТекущееЗначение) Экспорт
	Возврат Формат(ТекущееЗначение, "ЧРГ=''; ЧГ=0");
КонецФункции

Функция СформироватьТекстЗапроса(Данные)
	
	ТекстЗапроса = "";
	
	ТекстЗапроса = ТекстЗапроса + "--" + Данные["Boundary"] + Символы.ВК + Символы.ПС;
	ТекстЗапроса = ТекстЗапроса + "Content-Disposition: form-data; name=""" + Данные["name"] + """; filename=""" + Данные["ИмяФайла"] + """" + Символы.ВК + Символы.ПС;
	ТекстЗапроса = ТекстЗапроса + "Content-Type: application/x-zip-compressed" + Символы.ВК + Символы.ПС + Символы.ВК + Символы.ПС; 
	
	ДвоичныеДанныеСтрокой = ПолучитьДвоичныеДанныеВСтрокуБезКодирования(Данные["ИмяФайлаПолное"]);
	
	ТекстЗапроса = ТекстЗапроса + ДвоичныеДанныеСтрокой + Символы.ВК + Символы.ПС;
	
	ТекстЗапроса = ТекстЗапроса + "--" + Данные["Boundary"] + "--" + Символы.ВК + Символы.ПС;
	
	Возврат ТекстЗапроса;
КонецФункции

Функция ПолучитьДвоичныеДанныеВСтрокуБезКодирования(ИмяФайлаПолное)
	
	ТекстовыйДокумент = Новый ТекстовыйДокумент;
	ТекстовыйДокумент.Прочитать(ИмяФайлаПолное, КодировкаТекста.ANSI, Символы.ПС);
	
	Возврат ТекстовыйДокумент.ПолучитьТекст();
КонецФункции
 
#КонецОбласти 

#Область Переопределяемые

Функция ПолучитьAccessToken()
	Возврат "5536513321:AAHvMZ7JkjpVAkRY5VO9zmvbgETBNDud4Tc";
КонецФункции

Функция ПолучитьПутьКФайлуЛога()
	Возврат "D:\log.txt";
КонецФункции
 
#КонецОбласти

#КонецОбласти  

//&НаСервере
//Процедура getUpdatesНаСервере()Экспорт 
//	Результат = SDK_Telegram.ПолучитьСпиокСообщений();
//	РезультатЗапроса = SDK_Telegram.СформироватьJSON(Результат, Истина);
//КонецПроцедуры

 